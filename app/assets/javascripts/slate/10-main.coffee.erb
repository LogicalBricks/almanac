$(document).ready ->
  background = $("body").data("background")
  image = new Image()
  options = { amount: 1 }

  image.onload = ->
    Pixastic.process (Pixastic.process image, "blurfast", options), "blur", options
    $.backstretch options.resultCanvas.toDataURL('image/png')

  image.src = if background? then background else "<%= asset_path('slate/background.jpg') %>"

  $(".custom-upload input[type=file]").change ->
    $("#new_image input[type=submit]").show()
    $(this).next().find("input").val $(this).val()

  $("a.popup").click (e) ->
    e.preventDefault()
    window.open(this.href, "mywindow","width=600,height=300")

  $("a.add-photo").click (e) ->
    e.preventDefault()
    $("#post_body").val($("#post_body").val() + "\n\n![](" + $(this).data("image") + ")\n\n")

  $(".delete-post").bind ("ajax:success"), ->
    post = $(this).parent().parent()
    if post.prev().attr('class') is "head" and post.next().attr('class') is "head"
      post.prev().fadeOut()
    post.fadeOut()

  $(".delete-comment").bind ("ajax:success"), ->
    comment = $(this).parent().parent()
    if comment.prev().prop("tagName") is "H4" and comment.next().prop("tagName") is "HR"
      comment.prev().fadeOut()
      comment.next().fadeOut()
    comment.fadeOut()

  $('.datepicker').datepicker({ format: 'yyyy-mm-dd' })